name: Android Auto-Port Final Fix

on:
  workflow_dispatch:
  push:
    branches: [ "main", "master" ]

permissions:
  contents: write

jobs:
  convert-and-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 1. LIMPEZA
      - name: Clean Desktop Files & Create Directories
        run: |
          rm -rf cmd internal build .github/workflows/release.yml || true
          
          mkdir -p mobile
          mkdir -p android/app/src/main/java/com/kaishuu0123/chibisnes
          mkdir -p android/app/src/main/res/layout
          mkdir -p android/app/src/main/res/values
          mkdir -p android/app/src/main/res/mipmap-hdpi
          mkdir -p android/gradle/wrapper

      # 2. CRIAÇÃO DA PONTE GO
      - name: Generate mobile/lib.go
        run: |
          cat << 'EOF' > mobile/lib.go
          package mobile

          import (
            "github.com/kaishuu0123/chibisnes/chibisnes"
          )

          var console *chibisnes.Console

          func Start(romData []byte) string {
            if len(romData) == 0 { return "ROM vazia" }
            console = chibisnes.NewConsole()
            if err := console.LoadROM("game.sfc", romData, len(romData)); err != nil {
               return err.Error()
            }
            return ""
          }

          func RunFrame() []byte {
            if console == nil { return nil }
            console.RunFrame()
            
            width, height := 512, 478
            buf := make([]byte, width*height*4) 
            console.SetPixels(buf)
            return buf
          }

          func GetAudioSamples() []byte {
            if console == nil { return nil }
            pcm := make([]int16, 735*2)
            console.SetAudioSamples(pcm, 735)
            
            out := make([]byte, len(pcm)*2)
            for i, v := range pcm {
              out[i*2] = byte(v)
              out[i*2+1] = byte(v >> 8)
            }
            return out
          }

          func SetInput(btnID int, pressed bool) {
            if console != nil {
              console.SetButtonState(1, btnID, pressed)
            }
          }
          EOF

      # 3. CRIAÇÃO DOS ARQUIVOS GRADLE (A CORREÇÃO PRINCIPAL ESTÁ AQUI)
      
      # Cria o build.gradle da RAIZ (android/build.gradle) para definir os plugins
      - name: Generate Root build.gradle
        run: |
          cat << 'EOF' > android/build.gradle
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.2.0'
                  classpath 'org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.20'
              }
          }
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          task clean(type: Delete) {
              delete rootProject.buildDir
          }
          EOF

      - name: Generate settings.gradle
        run: |
          cat << 'EOF' > android/settings.gradle
          rootProject.name = "ChibiSNES"
          include ':app'
          EOF

      - name: Generate app/build.gradle
        run: |
          cat << 'EOF' > android/app/build.gradle
          plugins {
              id 'com.android.application'
              id 'org.jetbrains.kotlin.android'
          }

          android {
              namespace 'com.kaishuu0123.chibisnes'
              compileSdk 34

              defaultConfig {
                  applicationId "com.kaishuu0123.chibisnes"
                  minSdk 26
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
                  ndk {
                    abiFilters 'arm64-v8a', 'armeabi-v7a', 'x86_64'
                  }
              }

              // CORREÇÃO: Alinhar versões do Java e Kotlin para 1.8
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }
              kotlinOptions {
                  jvmTarget = '1.8'
              }

              sourceSets {
                  main { jniLibs.srcDirs = ['src/main/jniLibs'] }
              }
          }

          dependencies {
              implementation 'androidx.core:core-ktx:1.12.0'
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'com.google.android.material:material:1.11.0'
              implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
          }
          EOF

      # 4. CÓDIGO FONTE ANDROID (KOTLIN)
      - name: Generate AndroidManifest.xml
        run: |
          cat << 'EOF' > android/app/src/main/AndroidManifest.xml
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <application android:label="ChibiSNES" android:theme="@style/Theme.AppCompat.NoActionBar">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
                  <activity android:name=".EmulatorActivity" 
                            android:screenOrientation="landscape"
                            android:configChanges="orientation|screenSize|keyboardHidden"/>
              </application>
          </manifest>
          EOF

      - name: Generate MainActivity.kt
        run: |
          cat << 'EOF' > android/app/src/main/java/com/kaishuu0123/chibisnes/MainActivity.kt
          package com.kaishuu0123.chibisnes
          import android.content.Intent
          import android.os.Bundle
          import android.widget.Button
          import androidx.activity.result.contract.ActivityResultContracts
          import androidx.appcompat.app.AppCompatActivity

          class MainActivity : AppCompatActivity() {
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  setContentView(R.layout.activity_main)
                  val picker = registerForActivityResult(ActivityResultContracts.GetContent()) { uri ->
                      uri?.let {
                          val i = Intent(this, EmulatorActivity::class.java)
                          i.data = it
                          startActivity(i)
                      }
                  }
                  findViewById<Button>(R.id.btnLoad).setOnClickListener { picker.launch("*/*") }
              }
          }
          EOF

      - name: Generate EmulatorActivity.kt
        run: |
          cat << 'EOF' > android/app/src/main/java/com/kaishuu0123/chibisnes/EmulatorActivity.kt
          package com.kaishuu0123.chibisnes
          import android.graphics.*
          import android.media.*
          import android.os.Bundle
          import android.view.*
          import android.widget.Button
          import androidx.appcompat.app.AppCompatActivity
          import mobile.Mobile
          import java.nio.ByteBuffer

          class EmulatorActivity : AppCompatActivity() {
              private lateinit var surfaceView: SurfaceView
              private var running = false
              private var audioTrack: AudioTrack? = null

              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  setContentView(R.layout.activity_emulator)
                  surfaceView = findViewById(R.id.surface)
                  setupBtns()

                  val uri = intent.data ?: return
                  val bytes = contentResolver.openInputStream(uri)?.use { it.readBytes() }
                  if (bytes != null) {
                      val err = Mobile.start(bytes)
                      if (err.isEmpty()) startLoop()
                  }
              }

              private fun setupBtns() {
                  bind(R.id.btnUp, 4); bind(R.id.btnDown, 5); bind(R.id.btnLeft, 6); bind(R.id.btnRight, 7)
                  bind(R.id.btnA, 8); bind(R.id.btnB, 0); bind(R.id.btnX, 9); bind(R.id.btnY, 1)
                  bind(R.id.btnStart, 3); bind(R.id.btnSelect, 2); bind(R.id.btnL, 10); bind(R.id.btnR, 11)
              }
              private fun bind(id: Int, emuId: Int) {
                  findViewById<View>(id).setOnTouchListener { _, e ->
                      when(e.action) {
                          MotionEvent.ACTION_DOWN -> Mobile.setInput(emuId, true)
                          MotionEvent.ACTION_UP -> Mobile.setInput(emuId, false)
                      }
                      true
                  }
              }

              private fun startLoop() {
                  running = true
                  val min = AudioTrack.getMinBufferSize(44100, AudioFormat.CHANNEL_OUT_STEREO, AudioFormat.ENCODING_PCM_16BIT)
                  audioTrack = AudioTrack.Builder()
                      .setAudioFormat(AudioFormat.Builder().setSampleRate(44100).setChannelMask(AudioFormat.CHANNEL_OUT_STEREO).setEncoding(AudioFormat.ENCODING_PCM_16BIT).build())
                      .setBufferSizeInBytes(min)
                      .setTransferMode(AudioTrack.MODE_STREAM)
                      .build()
                  audioTrack?.play()

                  Thread {
                      val bmp = Bitmap.createBitmap(512, 478, Bitmap.Config.ARGB_8888)
                      val rect = Rect()
                      while (running) {
                          val start = System.currentTimeMillis()
                          val pixels = Mobile.runFrame()
                          val audio = Mobile.getAudioSamples()

                          if (audio != null) audioTrack?.write(audio, 0, audio.size)
                          if (pixels != null) {
                              val holder = surfaceView.holder
                              if (holder.surface.isValid) {
                                  val c = holder.lockCanvas()
                                  if (c != null) {
                                      bmp.copyPixelsFromBuffer(ByteBuffer.wrap(pixels))
                                      rect.set(0, 0, c.width, c.height)
                                      c.drawColor(Color.BLACK)
                                      c.drawBitmap(bmp, null, rect, null)
                                      holder.unlockCanvasAndPost(c)
                                  }
                              }
                          }
                          val diff = System.currentTimeMillis() - start
                          if (diff < 16) Thread.sleep(16 - diff)
                      }
                  }.start()
              }
              override fun onDestroy() {
                  super.onDestroy()
                  running = false
                  audioTrack?.release()
              }
          }
          EOF

      - name: Generate Layouts
        run: |
          cat << 'EOF' > android/app/src/main/res/layout/activity_main.xml
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent" android:layout_height="match_parent"
              android:gravity="center" android:orientation="vertical">
              <Button android:id="@+id/btnLoad" android:text="Load ROM" android:layout_width="wrap_content" android:layout_height="wrap_content"/>
          </LinearLayout>
          EOF

          cat << 'EOF' > android/app/src/main/res/layout/activity_emulator.xml
          <RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent" android:layout_height="match_parent" android:background="#000">
              <SurfaceView android:id="@+id/surface" android:layout_width="match_parent" android:layout_height="match_parent" />
              
              <Button android:id="@+id/btnUp" android:text="^" android:layout_width="60dp" android:layout_height="60dp" android:layout_alignParentBottom="true" android:layout_marginLeft="60dp" android:layout_marginBottom="110dp"/>
              <Button android:id="@+id/btnDown" android:text="v" android:layout_width="60dp" android:layout_height="60dp" android:layout_alignParentBottom="true" android:layout_marginLeft="60dp" android:layout_marginBottom="10dp"/>
              <Button android:id="@+id/btnLeft" android:text="&lt;" android:layout_width="60dp" android:layout_height="60dp" android:layout_alignParentBottom="true" android:layout_marginLeft="10dp" android:layout_marginBottom="60dp"/>
              <Button android:id="@+id/btnRight" android:text="&gt;" android:layout_width="60dp" android:layout_height="60dp" android:layout_alignParentBottom="true" android:layout_marginLeft="110dp" android:layout_marginBottom="60dp"/>

              <Button android:id="@+id/btnA" android:text="A" android:layout_width="60dp" android:layout_height="60dp" android:layout_alignParentBottom="true" android:layout_alignParentRight="true" android:layout_marginRight="10dp" android:layout_marginBottom="60dp"/>
              <Button android:id="@+id/btnB" android:text="B" android:layout_width="60dp" android:layout_height="60dp" android:layout_alignParentBottom="true" android:layout_alignParentRight="true" android:layout_marginRight="60dp" android:layout_marginBottom="20dp"/>
              <Button android:id="@+id/btnX" android:text="X" android:layout_width="60dp" android:layout_height="60dp" android:layout_alignParentBottom="true" android:layout_alignParentRight="true" android:layout_marginRight="60dp" android:layout_marginBottom="100dp"/>
              <Button android:id="@+id/btnY" android:text="Y" android:layout_width="60dp" android:layout_height="60dp" android:layout_alignParentBottom="true" android:layout_alignParentRight="true" android:layout_marginRight="110dp" android:layout_marginBottom="60dp"/>

              <Button android:id="@+id/btnStart" android:text="St" android:layout_width="50dp" android:layout_height="40dp" android:layout_alignParentBottom="true" android:layout_centerHorizontal="true" android:layout_marginBottom="10dp" />
              <Button android:id="@+id/btnSelect" android:text="Sel" android:layout_width="50dp" android:layout_height="40dp" android:layout_alignParentBottom="true" android:layout_centerHorizontal="true" android:layout_marginRight="60dp" android:layout_marginBottom="10dp" />
              <Button android:id="@+id/btnL" android:text="L" android:layout_width="60dp" android:layout_height="40dp" android:layout_alignParentTop="true" android:layout_alignParentLeft="true" />
              <Button android:id="@+id/btnR" android:text="R" android:layout_width="60dp" android:layout_height="40dp" android:layout_alignParentTop="true" android:layout_alignParentRight="true" />
          </RelativeLayout>
          EOF

      # 5. AMBIENTE E BUILD (COM CORREÇÃO DE YAML E GOMOBILE)
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Go (Latest)
        uses: actions/setup-go@v4
        with:
          go-version: 'stable' 

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          gomobile init

      - name: Build Go Library (Android API 21)
        run: |
          # CORREÇÃO: Baixa a dependência obrigatória para o bind funcionar
          go get golang.org/x/mobile/bind
          
          mkdir -p android/app/src/main/jniLibs
          gomobile bind -target=android -androidapi 21 -o android/app/src/main/jniLibs/chibisnes.aar ./mobile

      - name: Build APK
        working-directory: ./android
        run: |
          # 1. Salva os arquivos de configuração reais
          mv build.gradle build.gradle.real
          mv settings.gradle settings.gradle.real
          
          # 2. Cria settings falso para o Gradle 9 não reclamar
          echo "rootProject.name = 'temp'" > settings.gradle
          
          # 3. Gera o Wrapper 8.2 (compatível)
          gradle wrapper --gradle-version 8.2 --distribution-type bin --no-daemon
          
          # 4. Restaura os arquivos reais
          mv build.gradle.real build.gradle
          mv settings.gradle.real settings.gradle
          
          # 5. CORREÇÃO: Cria o gradle.properties exigido pelo AndroidX
          echo "android.useAndroidX=true" > gradle.properties
          
          # 6. Executa o Build
          chmod +x gradlew
          ./gradlew assembleDebug --stacktrace

      # 6. COMMIT E UPLOAD
      - name: Commit Changes
        run: |
          git config --global user.name "AutoPort"
          git config --global user.email "autoport@bot"
          git add .
          git commit -m "Android Port Final Fix" || echo "Nada novo"
          git push

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: chibisnes-android-debug
          path: android/app/build/outputs/apk/debug/app-debug.apk
