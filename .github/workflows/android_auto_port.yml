name: Android Auto-Port & Build

on:
  workflow_dispatch: # Permite rodar manualmente pelo botão no GitHub
  push:
    branches: [ "main", "master" ]

# Permissão para o robô escrever no repositório (Commit/Push)
permissions:
  contents: write

jobs:
  convert-and-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 1. LIMPEZA E PREPARAÇÃO DOS ARQUIVOS
      # ---------------------------------------------------------
      - name: Clean Desktop Files & Create Directories
        run: |
          echo "Removendo arquivos de Desktop..."
          rm -rf cmd internal build .github/workflows/release.yml
          
          echo "Criando estrutura Android..."
          mkdir -p mobile
          mkdir -p android/app/src/main/java/com/kaishuu0123/chibisnes
          mkdir -p android/app/src/main/res/layout
          mkdir -p android/app/src/main/res/values
          mkdir -p android/app/src/main/res/mipmap-hdpi
          mkdir -p android/gradle/wrapper

      # ---------------------------------------------------------
      # 2. CRIAÇÃO DA PONTE GO (GOMOBILE)
      # ---------------------------------------------------------
      - name: Generate mobile/lib.go
        run: |
          cat << 'EOF' > mobile/lib.go
          package mobile

          import (
            "github.com/kaishuu0123/chibisnes/chibisnes"
          )

          var console *chibisnes.Console

          // Start inicializa o emulador
          func Start(romData []byte) string {
            if len(romData) == 0 {
              return "ROM vazia"
            }
            console = chibisnes.NewConsole()
            // Nome ficticio para carregar
            err := console.LoadROM("game.sfc", romData, len(romData))
            if err != nil {
              return err.Error()
            }
            return ""
          }

          // RunFrame roda 1 frame e retorna pixels RGBA
          // O buffer precisa ser grande o suficiente para cobrir o output do PPU (512*478*4 max)
          func RunFrame() []byte {
            if console == nil { return nil }
            
            console.RunFrame()
            
            // O emulador espera um buffer para preencher. 
            // Tamanho seguro: 512 largura * 480 altura * 4 bytes (RGBA)
            // O emulador original usa buffers grandes.
            width := 512
            height := 478 
            buf := make([]byte, width*height*4) 
            
            console.SetPixels(buf)
            return buf
          }

          // GetAudioSamples retorna audio PCM 16bit Stereo
          func GetAudioSamples() []byte {
            if console == nil { return nil }
            // 735 samples * 2 canais * 2 bytes
            pcm := make([]int16, 735*2)
            console.SetAudioSamples(pcm, 735)
            
            out := make([]byte, len(pcm)*2)
            for i, v := range pcm {
              // Little Endian
              out[i*2] = byte(v)
              out[i*2+1] = byte(v >> 8)
            }
            return out
          }

          // SetInput envia botoes (Player 1)
          func SetInput(btnID int, pressed bool) {
            if console != nil {
              console.SetButtonState(1, btnID, pressed)
            }
          }
          EOF

      # ---------------------------------------------------------
      # 3. CRIAÇÃO DOS ARQUIVOS ANDROID (KOTLIN/GRADLE)
      # ---------------------------------------------------------
      
      - name: Generate settings.gradle
        run: |
          cat << 'EOF' > android/settings.gradle
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "ChibiSNES"
          include ':app'
          EOF

      - name: Generate app/build.gradle
        run: |
          cat << 'EOF' > android/app/build.gradle
          plugins {
              id 'com.android.application'
              id 'org.jetbrains.kotlin.android'
          }

          android {
              namespace 'com.kaishuu0123.chibisnes'
              compileSdk 34

              defaultConfig {
                  applicationId "com.kaishuu0123.chibisnes"
                  minSdk 26
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
              }
              
              sourceSets {
                  main {
                      jniLibs.srcDirs = ['src/main/jniLibs']
                  }
              }
              
              buildFeatures {
                  viewBinding true
              }
          }

          dependencies {
              implementation 'androidx.core:core-ktx:1.12.0'
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'com.google.android.material:material:1.11.0'
              implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
          }
          EOF

      - name: Generate AndroidManifest.xml
        run: |
          cat << 'EOF' > android/app/src/main/AndroidManifest.xml
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <application
                  android:label="ChibiSNES"
                  android:theme="@style/Theme.AppCompat.NoActionBar">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
                  <activity android:name=".EmulatorActivity" 
                            android:screenOrientation="landscape"
                            android:configChanges="orientation|screenSize|keyboardHidden"/>
              </application>
          </manifest>
          EOF

      - name: Generate MainActivity.kt
        run: |
          cat << 'EOF' > android/app/src/main/java/com/kaishuu0123/chibisnes/MainActivity.kt
          package com.kaishuu0123.chibisnes

          import android.content.Intent
          import android.os.Bundle
          import android.widget.Button
          import androidx.activity.result.contract.ActivityResultContracts
          import androidx.appcompat.app.AppCompatActivity

          class MainActivity : AppCompatActivity() {
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  setContentView(R.layout.activity_main)

                  val picker = registerForActivityResult(ActivityResultContracts.GetContent()) { uri ->
                      uri?.let {
                          val i = Intent(this, EmulatorActivity::class.java)
                          i.data = it
                          startActivity(i)
                      }
                  }

                  findViewById<Button>(R.id.btnLoad).setOnClickListener {
                      picker.launch("*/*")
                  }
              }
          }
          EOF

      - name: Generate EmulatorActivity.kt
        run: |
          cat << 'EOF' > android/app/src/main/java/com/kaishuu0123/chibisnes/EmulatorActivity.kt
          package com.kaishuu0123.chibisnes

          import android.graphics.*
          import android.media.*
          import android.os.Bundle
          import android.view.*
          import android.widget.Button
          import androidx.appcompat.app.AppCompatActivity
          import mobile.Mobile
          import java.nio.ByteBuffer

          class EmulatorActivity : AppCompatActivity() {
              private lateinit var surfaceView: SurfaceView
              private var running = false
              private var audioTrack: AudioTrack? = null

              // IDs do chibisnes/controller.go
              // B=0, Y=1, Select=2, Start=3, Up=4, Down=5, Left=6, Right=7, A=8, X=9, L=10, R=11

              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  setContentView(R.layout.activity_emulator)
                  surfaceView = findViewById(R.id.surface)
                  
                  setupBtns()

                  val uri = intent.data ?: return
                  val bytes = contentResolver.openInputStream(uri)?.use { it.readBytes() }
                  
                  if (bytes != null) {
                      val err = Mobile.start(bytes)
                      if (err.isEmpty()) startLoop()
                  }
              }

              private fun setupBtns() {
                  bindBtn(R.id.btnUp, 4); bindBtn(R.id.btnDown, 5)
                  bindBtn(R.id.btnLeft, 6); bindBtn(R.id.btnRight, 7)
                  bindBtn(R.id.btnA, 8); bindBtn(R.id.btnB, 0)
                  bindBtn(R.id.btnX, 9); bindBtn(R.id.btnY, 1)
                  bindBtn(R.id.btnStart, 3); bindBtn(R.id.btnSelect, 2)
                  bindBtn(R.id.btnL, 10); bindBtn(R.id.btnR, 11)
              }

              private fun bindBtn(id: Int, emuId: Int) {
                  findViewById<View>(id).setOnTouchListener { _, e ->
                      when(e.action) {
                          MotionEvent.ACTION_DOWN -> Mobile.setInput(emuId, true)
                          MotionEvent.ACTION_UP -> Mobile.setInput(emuId, false)
                      }
                      true
                  }
              }

              private fun startLoop() {
                  running = true
                  val minBuf = AudioTrack.getMinBufferSize(44100, AudioFormat.CHANNEL_OUT_STEREO, AudioFormat.ENCODING_PCM_16BIT)
                  audioTrack = AudioTrack.Builder()
                      .setAudioFormat(AudioFormat.Builder().setSampleRate(44100).setChannelMask(AudioFormat.CHANNEL_OUT_STEREO).setEncoding(AudioFormat.ENCODING_PCM_16BIT).build())
                      .setBufferSizeInBytes(minBuf)
                      .setTransferMode(AudioTrack.MODE_STREAM)
                      .build()
                  audioTrack?.play()

                  Thread {
                      val bmp = Bitmap.createBitmap(512, 478, Bitmap.Config.ARGB_8888)
                      val rect = Rect()
                      while (running) {
                          val start = System.currentTimeMillis()
                          
                          val pixels = Mobile.runFrame()
                          val audio = Mobile.getAudioSamples()

                          if (audio != null) audioTrack?.write(audio, 0, audio.size)

                          if (pixels != null) {
                              val holder = surfaceView.holder
                              if (holder.surface.isValid) {
                                  val c = holder.lockCanvas()
                                  if (c != null) {
                                      bmp.copyPixelsFromBuffer(ByteBuffer.wrap(pixels))
                                      rect.set(0, 0, c.width, c.height)
                                      c.drawColor(Color.BLACK)
                                      c.drawBitmap(bmp, null, rect, null)
                                      holder.unlockCanvasAndPost(c)
                                  }
                              }
                          }
                          
                          val diff = System.currentTimeMillis() - start
                          if (diff < 16) Thread.sleep(16 - diff)
                      }
                  }.start()
              }

              override fun onDestroy() {
                  super.onDestroy()
                  running = false
                  audioTrack?.release()
              }
          }
          EOF

      - name: Generate Layouts XML
        run: |
          # activity_main.xml
          cat << 'EOF' > android/app/src/main/res/layout/activity_main.xml
          <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent"
              android:layout_height="match_parent"
              android:gravity="center"
              android:orientation="vertical">
              <Button android:id="@+id/btnLoad" android:text="Load ROM" android:layout_width="wrap_content" android:layout_height="wrap_content"/>
          </LinearLayout>
          EOF

          # activity_emulator.xml (Com controles na tela)
          cat << 'EOF' > android/app/src/main/res/layout/activity_emulator.xml
          <RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
              android:layout_width="match_parent" android:layout_height="match_parent" android:background="#000">
              
              <SurfaceView android:id="@+id/surface" android:layout_width="match_parent" android:layout_height="match_parent" />
              
              <!-- D-PAD -->
              <Button android:id="@+id/btnUp" android:text="^" android:layout_width="60dp" android:layout_height="60dp" android:layout_alignParentBottom="true" android:layout_marginLeft="60dp" android:layout_marginBottom="110dp"/>
              <Button android:id="@+id/btnDown" android:text="v" android:layout_width="60dp" android:layout_height="60dp" android:layout_alignParentBottom="true" android:layout_marginLeft="60dp" android:layout_marginBottom="10dp"/>
              <Button android:id="@+id/btnLeft" android:text="&lt;" android:layout_width="60dp" android:layout_height="60dp" android:layout_alignParentBottom="true" android:layout_marginLeft="10dp" android:layout_marginBottom="60dp"/>
              <Button android:id="@+id/btnRight" android:text="&gt;" android:layout_width="60dp" android:layout_height="60dp" android:layout_alignParentBottom="true" android:layout_marginLeft="110dp" android:layout_marginBottom="60dp"/>

              <!-- Action Buttons -->
              <Button android:id="@+id/btnA" android:text="A" android:layout_width="60dp" android:layout_height="60dp" android:layout_alignParentBottom="true" android:layout_alignParentRight="true" android:layout_marginRight="10dp" android:layout_marginBottom="60dp"/>
              <Button android:id="@+id/btnB" android:text="B" android:layout_width="60dp" android:layout_height="60dp" android:layout_alignParentBottom="true" android:layout_alignParentRight="true" android:layout_marginRight="60dp" android:layout_marginBottom="20dp"/>
              <Button android:id="@+id/btnX" android:text="X" android:layout_width="60dp" android:layout_height="60dp" android:layout_alignParentBottom="true" android:layout_alignParentRight="true" android:layout_marginRight="60dp" android:layout_marginBottom="100dp"/>
              <Button android:id="@+id/btnY" android:text="Y" android:layout_width="60dp" android:layout_height="60dp" android:layout_alignParentBottom="true" android:layout_alignParentRight="true" android:layout_marginRight="110dp" android:layout_marginBottom="60dp"/>

              <!-- Misc -->
              <Button android:id="@+id/btnStart" android:text="St" android:layout_width="50dp" android:layout_height="40dp" android:layout_alignParentBottom="true" android:layout_centerHorizontal="true" android:layout_marginBottom="10dp" />
              <Button android:id="@+id/btnSelect" android:text="Sel" android:layout_width="50dp" android:layout_height="40dp" android:layout_alignParentBottom="true" android:layout_centerHorizontal="true" android:layout_marginRight="60dp" android:layout_marginBottom="10dp" />
              <Button android:id="@+id/btnL" android:text="L" android:layout_width="60dp" android:layout_height="40dp" android:layout_alignParentTop="true" android:layout_alignParentLeft="true" />
              <Button android:id="@+id/btnR" android:text="R" android:layout_width="60dp" android:layout_height="40dp" android:layout_alignParentTop="true" android:layout_alignParentRight="true" />
          </RelativeLayout>
          EOF

      # ---------------------------------------------------------
      # 4. CONFIGURAÇÃO DE AMBIENTE E BUILD
      # ---------------------------------------------------------
      
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install & Init Gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          gomobile init

      - name: Build Go Library (Gomobile Bind)
        run: |
          go get golang.org/x/mobile/bind
          mkdir -p android/app/src/main/jniLibs
          # Cria o arquivo .aar na pasta do android
          gomobile bind -target=android -o android/app/src/main/jniLibs/chibisnes.aar ./mobile

      - name: Setup Gradle Wrapper
        working-directory: ./android
        run: gradle wrapper

      - name: Build APK (Debug)
        working-directory: ./android
        run: ./gradlew assembleDebug --stacktrace

      # ---------------------------------------------------------
      # 5. COMMIT & PUSH DAS ALTERAÇÕES
      # ---------------------------------------------------------
      - name: Commit and Push Android Project
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add .
          git commit -m "Auto-port to Android structure" || echo "Nada para comitar"
          git push

      # ---------------------------------------------------------
      # 6. UPLOAD DO APK FINAL
      # ---------------------------------------------------------
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: chibisnes-android-debug
          path: android/app/build/outputs/apk/debug/app-debug.apk
